name: CI/CD - Prueba Tecnica

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  IMAGE_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login a ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Construir imagen Docker
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

      - name: Etiquetar imagen
        run: |
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Push a ECR
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Scan de imagen con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          format: 'table'
          exit-code: '0'
          output: 'trivy-report.txt'

      - name: Subir reporte Trivy
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy a EC2 por SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
            ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
            AWS_REGION="${{ env.AWS_REGION }}"

            aws ecr get-login-password --region $AWS_REGION \
              | sudo docker login --username AWS --password-stdin $ECR_REGISTRY

            sudo docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest

            if [ ! -f /etc/nginx/sites-available/prueba-tecnica ]; then
              sudo bash -c 'cat > /etc/nginx/sites-available/prueba-tecnica << "EOF"
server {
    listen 80;
    server_name _;

    location /prueba-tecnica {
        proxy_pass http://127.0.0.1:3000/prueba-tecnica;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header X-Frame-Options "DENY";
        add_header X-Content-Type-Options "nosniff";
        add_header Referrer-Policy "no-referrer";
    }
}
EOF'
              sudo rm -f /etc/nginx/sites-enabled/default || true
              sudo ln -s /etc/nginx/sites-available/prueba-tecnica /etc/nginx/sites-enabled/prueba-tecnica
              sudo nginx -t
              sudo systemctl reload nginx
            fi

            if sudo docker ps -a --format '{{.Names}}' | grep -Eq "^prueba-tecnica$"; then
              sudo docker stop prueba-tecnica || true
              sudo docker rm prueba-tecnica || true
            fi

            sudo docker run -d --name prueba-tecnica \
              -p 3000:3007 \
              -e APP_RUNTIME_MESSAGE="Desplegado desde CI/CD" \
              --restart unless-stopped \
              $ECR_REGISTRY/$ECR_REPOSITORY:latest